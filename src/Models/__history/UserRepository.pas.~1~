unit UserRepository;

interface

uses
  System.SysUtils, FireDAC.Comp.Client, UserModel, DatabaseConnection,
  System.Hash,
  FireDAC.Stan.Param, FireDAC.DApt, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.Phys.Intf, FireDAC.DatS, FireDAC.Phys,
  FireDAC.VCLUI.Wait;

type
  TUserRepository = class
  public
    class function Register(User: TUser): Boolean;
    class function Authenticate(Email, Password: string): Boolean;
  end;

implementation

class function TUserRepository.Register(User: TUser): Boolean;
var
  Query: TFDQuery;
begin
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := TDatabaseConnection.GetInstance.GetConnection;
    Query.SQL.Text :=
      'INSERT INTO USERS (ID, NAME, EMAIL, PASSWORD_HASH) VALUES (:ID, :NAME, :EMAIL, :PASSWORD_HASH)';
    Query.ParamByName('ID').AsString := TGUID.NewGuid.ToString;
    Query.ParamByName('NAME').AsString := User.Name;
    Query.ParamByName('EMAIL').AsString := User.Email;
    Query.ParamByName('PASSWORD_HASH').AsString :=
      THashSHA2.GetHashString(User.Password);
    Query.ExecSQL;
    Result := True;
  finally
    Query.Free;
  end;
end;

class function TUserRepository.Authenticate(Email, Password: string): Boolean;
var
  Query: TFDQuery;
begin
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := TDatabaseConnection.GetInstance.GetConnection;
    Query.SQL.Text :=
      'SELECT ID FROM USERS WHERE EMAIL = :EMAIL AND PASSWORD_HASH = :PASSWORD_HASH';
    Query.ParamByName('EMAIL').AsString := Email;
    Query.ParamByName('PASSWORD_HASH').AsString :=
      THashSHA2.GetHashString(Password);
    Query.Open;
    Result := not Query.IsEmpty;
  finally
    Query.Free;
  end;
end;

end.
